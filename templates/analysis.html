{% extends 'base.html' %}
{% block content %}
{% if processing %}
<p>Analysis is being processed. Please reload this page later.</p>
{% elif not mistakes %}
<p>No analysis available. Run training first.</p>
{% else %}
<h1>Training Board</h1>
<iframe id="board" frameborder="0" style="width:100%; aspect-ratio:4/3;"></iframe>
<div id="info" class="my-2"></div>
<div class="input-group mb-3" style="max-width:200px;">
  <input id="moveInput" class="form-control" placeholder="e2e4">
  <button class="btn btn-outline-secondary" onclick="checkMove()">Check Move</button>
</div>
<div id="controls" class="mb-3">
  <button class="btn btn-secondary" onclick="prev()">Previous</button>
  <button class="btn btn-secondary" onclick="next()">Next</button>
</div>
<script>
const mistakes = {{ mistakes|tojson }};
let index = 0;
function show(){
    if(!mistakes.length) return;
    const m = mistakes[index];
    const orientation = m.fen.split(' ')[1] === 'w' ? 'white' : 'black';
    const fenParam = m.fen.replace(/ /g, '_');
    document.getElementById('board').src =
        `https://lichess.org/embed/analysis?fen=${fenParam}&color=${orientation}`;
    document.getElementById("info").innerHTML = `<p>Frequency: ${m.game_count}</p><p>Your move: ${m.user_move}</p>`;
    document.getElementById("moveInput").value = "";
}
function checkMove(){
    const move = document.getElementById("moveInput").value.trim();
    if(!move) return;
    const m = mistakes[index];
    if(m.top_moves.includes(move)) alert("Good move!");
    else alert("Not a top move");
}
function prev(){ if(index>0){ index--; show(); } }
function next(){ if(index < mistakes.length-1){ index++; show(); } }
show();
</script>
{% endif %}
{% endblock %}
