{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
  <div>
    <h1 class="mb-1">ğŸ“ Training Dashboard</h1>
    <p class="subtle mb-0">Configure and launch Stockfish analysis on your games.</p>
  </div>
  <div class="d-flex gap-2 flex-wrap">
    <span class="badge-soft">Depth {{ analysis_depth }}</span>
    <span class="badge-soft">{{ opening_plies_limit }} plies</span>
    <span class="badge-soft">Min freq {{ min_pair_occurrences }}</span>
    <span class="badge-soft">â‰¥ {{ mistake_threshold_cp }}cp</span>
  </div>
</div>

<!-- Engine Status -->
<div class="hero-card mb-4">
  <div class="d-flex flex-wrap justify-content-between gap-3 align-items-start">
    <div>
      <div class="d-flex align-items-center gap-2 mb-2">
        {% if engine_ok %}
        <span class="status-badge success">
          <span class="status-dot"></span>
          Engine Ready
        </span>
        {% else %}
        <span class="status-badge error">
          <span class="status-dot"></span>
          Engine Unavailable
        </span>
        {% endif %}
      </div>
      <div class="h5 mb-1">{{ engine_status }}</div>
      {% if bundled_stockfish_note %}
        <div class="subtle small">{{ bundled_stockfish_note }}</div>
      {% endif %}
    </div>
    
    {% if not engine_ok %}
    <div class="text-end">
      {% if engine_install_label and engine_install_value %}
        <div class="text-muted small mb-2">{{ engine_install_label }}</div>
        {% if engine_install_value.startswith('http') %}
          <a class="btn btn-outline-light btn-sm" href="{{ engine_install_value }}" target="_blank">
            ğŸ“¥ Download Stockfish
          </a>
        {% else %}
          <code class="d-block p-2 rounded" style="background: rgba(255,255,255,0.05);">{{ engine_install_value }}</code>
        {% endif %}
      {% endif %}
      <div class="subtle small mt-2">Or set <code>STOCKFISH_PATH</code> environment variable.</div>
    </div>
    {% else %}
    <div class="text-end">
      <div class="text-muted small mb-1">Analysis Configuration</div>
      <div class="badge-soft">Depth {{ analysis_depth }} Â· MultiPV 5</div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Data Status -->
<div class="row g-3 mb-4">
  <div class="col-md-6">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <div class="text-muted small">â¬œ White Repertoire</div>
          <h5 class="mb-0">White Games</h5>
        </div>
        {% if white_status.has_pgn %}
          {% if white_status.is_processing %}
          <span class="status-badge processing">
            <span class="status-dot"></span>
            Analyzing
          </span>
          {% elif white_status.has_results %}
          <span class="status-badge success">
            <span class="status-dot"></span>
            Ready
          </span>
          {% elif white_status.has_error %}
          <span class="status-badge error">
            <span class="status-dot"></span>
            Error
          </span>
          {% else %}
          <span class="status-badge warning">
            <span class="status-dot"></span>
            Not Analyzed
          </span>
          {% endif %}
        {% else %}
        <span class="status-badge" style="background: rgba(148, 163, 184, 0.15); color: var(--muted);">
          <span class="status-dot"></span>
          No Data
        </span>
        {% endif %}
      </div>
      
      {% if white_status.has_pgn %}
      <p class="subtle small mb-3">
        {% if white_status.is_processing %}
        Analysis is running. Check back in a few minutes.
        {% elif white_status.has_results %}
        Analysis complete. View your white opening mistakes.
        {% else %}
        PGN uploaded. Start analysis to find mistakes.
        {% endif %}
      </p>
      {% else %}
      <p class="subtle small mb-3">No white PGN uploaded yet. Go to Upload to add games.</p>
      {% endif %}
      
      <div class="d-flex gap-2 mt-auto">
        {% if white_status.has_results %}
        <a href="{{ url_for('analysis_color', color='white') }}" class="btn btn-outline-light flex-grow-1">
          ğŸ“Š View Results
        </a>
        {% endif %}
        <form action="{{ url_for('train_color', color='white') }}" method="post" class="flex-grow-1">
          <button type="submit" class="btn btn-primary w-100" 
            {% if not engine_ok or not white_status.has_pgn or white_status.is_processing %}disabled{% endif %}>
            {% if white_status.is_processing %}â³ Analyzing...{% else %}ğŸ” Analyze{% endif %}
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <div class="text-muted small">â¬› Black Repertoire</div>
          <h5 class="mb-0">Black Games</h5>
        </div>
        {% if black_status.has_pgn %}
          {% if black_status.is_processing %}
          <span class="status-badge processing">
            <span class="status-dot"></span>
            Analyzing
          </span>
          {% elif black_status.has_results %}
          <span class="status-badge success">
            <span class="status-dot"></span>
            Ready
          </span>
          {% elif black_status.has_error %}
          <span class="status-badge error">
            <span class="status-dot"></span>
            Error
          </span>
          {% else %}
          <span class="status-badge warning">
            <span class="status-dot"></span>
            Not Analyzed
          </span>
          {% endif %}
        {% else %}
        <span class="status-badge" style="background: rgba(148, 163, 184, 0.15); color: var(--muted);">
          <span class="status-dot"></span>
          No Data
        </span>
        {% endif %}
      </div>
      
      {% if black_status.has_pgn %}
      <p class="subtle small mb-3">
        {% if black_status.is_processing %}
        Analysis is running. Check back in a few minutes.
        {% elif black_status.has_results %}
        Analysis complete. View your black opening mistakes.
        {% else %}
        PGN uploaded. Start analysis to find mistakes.
        {% endif %}
      </p>
      {% else %}
      <p class="subtle small mb-3">No black PGN uploaded yet. Go to Upload to add games.</p>
      {% endif %}
      
      <div class="d-flex gap-2 mt-auto">
        {% if black_status.has_results %}
        <a href="{{ url_for('analysis_color', color='black') }}" class="btn btn-outline-light flex-grow-1">
          ğŸ“Š View Results
        </a>
        {% endif %}
        <form action="{{ url_for('train_color', color='black') }}" method="post" class="flex-grow-1">
          <button type="submit" class="btn btn-primary w-100" 
            {% if not engine_ok or not black_status.has_pgn or black_status.is_processing %}disabled{% endif %}>
            {% if black_status.is_processing %}â³ Analyzing...{% else %}ğŸ” Analyze{% endif %}
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Analyze Both -->
<div class="card p-4 text-center">
  <h4 class="mb-2">ğŸ¯ Analyze Both Colors</h4>
  <p class="subtle mb-3">Queue analysis for white and black together. Perfect after uploading new games.</p>
  <form action="{{ url_for('train_color', color='both') }}" method="post" class="d-inline-block">
    <button type="submit" class="btn btn-primary btn-lg px-5" 
      {% if not engine_ok or (not white_status.has_pgn and not black_status.has_pgn) %}disabled{% endif %}>
      ğŸš€ Analyze Both Colors
    </button>
  </form>
  
  {% if white_status.has_results or black_status.has_results %}
  <div class="mt-3">
    <a href="{{ url_for('analysis') }}" class="btn btn-outline-light">
      ğŸ“Š View Combined Results
    </a>
  </div>
  {% endif %}
</div>

<!-- Auto-refresh if processing -->
{% if white_status.is_processing or black_status.is_processing %}
<script>
  setTimeout(() => location.reload(), 10000);
</script>
{% endif %}
{% endblock %}
