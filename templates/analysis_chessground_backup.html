{% extends 'base.html' %}
{% block content %}

<!-- Chessground Styles -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessground@11.3.0/dist/chessground.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/chessground.css') }}">

{% if processing %}
<div class="alert alert-info d-flex align-items-center justify-content-between">
  <div class="d-flex align-items-center gap-3">
    <div class="processing-indicator">
      <span class="processing-dot"></span>
      <span class="processing-dot"></span>
      <span class="processing-dot"></span>
    </div>
    <span>Analysis is running. Page will auto-refresh when complete.</span>
  </div>
  <button class="btn btn-sm btn-outline-light" onclick="location.reload()">Refresh Now</button>
</div>
{% endif %}

{% if not mistakes %}
  {% if processing %}
    <div class="hero-card text-center py-5">
      <div class="mb-3" style="font-size: 3rem;">â³</div>
      <h3>Analysis In Progress</h3>
      <p class="text-muted mb-0">Your games are being analyzed. This page will update automatically.</p>
    </div>
  {% else %}
    <div class="hero-card text-center py-5">
      <div class="mb-3" style="font-size: 3rem;">ğŸ“Š</div>
      <h3>No Analysis Available</h3>
      <p class="text-muted mb-3">Upload some PGN files and run the trainer to see your opening mistakes.</p>
      <a href="{{ url_for('train') }}" class="btn btn-primary">Go to Training</a>
    </div>
  {% endif %}
{% else %}

<!-- Header Section -->
<div class="hero-card mb-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
    <div>
      <div class="section-title">
        <h1 class="mb-1">ğŸ¯ Opening Trainer{% if color %} Â· {{ color|title }}{% endif %}</h1>
        {% if processing %}
        <span class="status-badge processing">
          <span class="status-dot"></span>
          Processing
        </span>
        {% else %}
        <span class="status-badge success">
          <span class="status-dot"></span>
          Ready to Train
        </span>
        {% endif %}
      </div>
      <p class="subtle mb-0">Replay your mistakes and master engine suggestions through active training.</p>
    </div>
    <div class="text-end">
      <div class="d-flex gap-2 mb-2">
        <button class="btn btn-sm btn-outline-light" id="statsToggle" onclick="toggleStatsPanel()">ğŸ“ˆ Stats</button>
        <button class="btn btn-sm btn-outline-light" id="settingsToggle" onclick="toggleSettingsPanel()">âš™ï¸ Settings</button>
      </div>
      <div class="badge-soft mb-2">â‰¥ {{ threshold_cp }} cp</div>
      <div class="subtle small">Depth: {{ opening_plies_limit or 20 }} plies</div>
    </div>
  </div>
</div>

<!-- Stats Panel (Hidden by default) -->
<div id="statsPanel" class="card p-3 mb-4 d-none">
  <div class="stat-grid">
    <div class="stat-card">
      <div class="stat-label">Total Mistakes</div>
      <div class="stat-value">{{ stats.total }}</div>
      <div class="small subtle">
        {% if stats.white_count > 0 or stats.black_count > 0 %}
          â¬œ {{ stats.white_count or 0 }} Â· â¬› {{ stats.black_count or 0 }}
        {% endif %}
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Avg CP Loss</div>
      <div class="stat-value">{{ stats.avg_cp }}</div>
      <div class="small subtle">Median {{ stats.median_cp }} Â· Peak {{ stats.max_cp }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Frequency</div>
      <div class="stat-value">{{ stats.total_frequency }}</div>
      <div class="small subtle">Times played</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Mastery Rate</div>
      <div id="masteryRate" class="stat-value">0%</div>
      <div class="small subtle">Deleted / Total</div>
    </div>
  </div>
</div>

<!-- Settings Panel (Hidden by default) -->
<div id="settingsPanel" class="card p-3 mb-4 d-none">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label small">ğŸ” Search</label>
      <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="Filter moves...">
    </div>
    <div class="col-md-2">
      <label class="form-label small">ğŸ“Š Min CP</label>
      <input id="minCpInput" type="number" class="form-control form-control-sm" min="0" step="10" value="{{ threshold_cp }}">
    </div>
    <div class="col-md-2">
      <label class="form-label small">ğŸ¯ Severity</label>
      <select id="severityFilter" class="form-select form-select-sm">
        <option value="">All</option>
        <option value="severe">Severe (300+)</option>
        <option value="high">High (180-299)</option>
        <option value="moderate">Moderate</option>
      </select>
    </div>
    <div class="col-md-3">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="onlyTopInput">
        <label class="form-check-label small" for="onlyTopInput">Engine lines only</label>
      </div>
    </div>
    <div class="col-md-2">
      <button class="btn btn-sm btn-outline-light w-100" onclick="resetFilters()">Reset</button>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="row g-4">
  <!-- Board Column -->
  <div class="col-lg-6">
    <div class="card p-3 mb-3">
      <!-- Board Container -->
      <div id="boardContainer" style="width: 100%; max-width: 600px; margin: 0 auto;">
        <div id="board"></div>
      </div>
      
      <!-- Position Info -->
      <div id="info" class="mt-3 mb-3"></div>
      
      <!-- Engine Suggestions -->
      <div class="mb-3">
        <div class="text-muted small mb-2">ğŸ‘‘ Best Moves (Click to Preview)</div>
        <div id="topMoves" class="chip-list"></div>
      </div>
      
      <!-- Board Controls -->
      <div class="btn-group w-100 mb-3" role="group">
        <button type="button" class="btn btn-sm btn-outline-light" onclick="jumpTo(0)" title="First">â®</button>
        <button type="button" class="btn btn-sm btn-outline-light" onclick="prev()" title="Previous">â—€</button>
        <button type="button" class="btn btn-sm btn-outline-light flex-grow-1" id="posCounter" disabled>
          <span id="posText">Position 1</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-light" onclick="next()" title="Next">â–¶</button>
        <button type="button" class="btn btn-sm btn-outline-light" onclick="jumpTo(filtered.length - 1)" title="Last">â­</button>
      </div>
      
      <!-- Board Actions -->
      <div class="row g-2">
        <div class="col-6">
          <button class="btn btn-outline-light btn-sm w-100" onclick="flipBoard()" title="Flip board">ğŸ”„ Flip</button>
        </div>
        <div class="col-6">
          <button class="btn btn-outline-light btn-sm w-100" onclick="copyFen()" title="Copy FEN">ğŸ“‹ FEN</button>
        </div>
        <div class="col-6">
          <button class="btn btn-outline-light btn-sm w-100" onclick="giveUp()" title="Show best move">ğŸ’¡ Hint</button>
        </div>
        <div class="col-6">
          <a id="lichessLink" href="#" target="_blank" class="btn btn-outline-light btn-sm w-100">ğŸ”— Lichess</a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Table Column -->
  <div class="col-lg-6">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">ğŸ“‹ Mistake List <span id="mistakeCount" class="badge bg-primary">{{ mistakes|length }}</span></h5>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-light" onclick="exportAnalysis()" title="Export to JSON">
            ğŸ“¥ Export
          </button>
          <button class="btn btn-sm btn-outline-light" onclick="printAnalysis()" title="Print analysis">
            ğŸ–¨ï¸ Print
          </button>
        </div>
      </div>
      
      <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
        <table class="table table-striped table-sm align-middle mb-0">
          <thead style="position: sticky; top: 0; background: var(--panel); z-index: 10;">
            <tr>
              <th style="width: 40px;" onclick="setSort('index')" role="button" class="cursor-pointer"># <span class="sort-icon" data-key="index">â‡…</span></th>
              <th style="width: 60px;" onclick="setSort('pair_count')" role="button" class="cursor-pointer">Freq <span class="sort-icon" data-key="pair_count">â‡…</span></th>
              <th style="width: 70px;" onclick="setSort('avg_cp_loss')" role="button" class="cursor-pointer">CP <span class="sort-icon" data-key="avg_cp_loss">â‡…</span></th>
              <th>Move</th>
              <th style="width: 90px;">Severity</th>
              <th style="width: 100px;">Actions</th>
            </tr>
          </thead>
          <tbody id="mistakeTable"></tbody>
        </table>
      </div>
      <div id="emptyFiltered" class="alert alert-secondary mt-3 d-none text-center mb-0">
        No mistakes match filters.
      </div>
    </div>
  </div>
</div>

<!-- Chessground Library -->
<script src="https://cdn.jsdelivr.net/npm/chessground@11.3.0/dist/chessground.umd.js"></script>
<script src="{{ url_for('static', filename='js/chess.min.js') }}"></script>

<script>
// ============================================================================
// Global State
// ============================================================================
const mistakes = {{ mistakes|tojson }};
const color = {{ color|tojson }};
let index = 0;
let board = null;
let game = null;
let filtered = [...mistakes];
let sortKey = "pair_count";
let sortDir = "desc";
let deletedCount = 0;

// Auto-refresh if processing
{% if processing %}
setTimeout(() => location.reload(), 10000);
{% endif %}

// ============================================================================
// UI Toggle Functions
// ============================================================================
function toggleStatsPanel() {
  const panel = document.getElementById('statsPanel');
  panel.classList.toggle('d-none');
  document.getElementById('statsToggle').classList.toggle('active');
}

function toggleSettingsPanel() {
  const panel = document.getElementById('settingsPanel');
  panel.classList.toggle('d-none');
  document.getElementById('settingsToggle').classList.toggle('active');
}

// ============================================================================
// Board Setup & Control
// ============================================================================
function initChessboard() {
  console.log('Initializing chessboard...');
  const container = document.getElementById('board');
  if (!container) {
    console.error('Board container not found');
    return;
  }
  
  console.log('Container found:', container);
  
  // Ensure Chessground is available
  if (typeof window.Chessground === 'undefined') {
    console.error('Chessground library not loaded. Trying again in 500ms');
    setTimeout(initChessboard, 500);
    return;
  }
  
  console.log('Chessground available, creating board...');
  
  try {
    board = window.Chessground(container, {
      fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
      orientation: 'white',
      coordinates: true,
      highlight: {
        lastMove: true,
        check: true
      },
      movable: {
        free: false,
        color: 'white',
        showDests: true,
        events: {
          after: handleMove
        }
      },
      drawable: {
        enabled: true,
        visible: true
      },
      premovable: {
        enabled: false
      }
    });
    console.log('Chessboard created successfully!');
  } catch (e) {
    console.error('Failed to create chessboard:', e);
  }
}

function flipBoard() {
  const current = board.state.orientation;
  board.set({ orientation: current === 'white' ? 'black' : 'white' });
}

function handleMove(source, destination) {
  if (!game) return;
  
  const move = game.move({
    from: source,
    to: destination,
    promotion: 'q'
  });
  
  if (move === null) {
    board.set({ fen: game.fen() });
    return;
  }
  
  const m = filtered[index];
  const uci = move.from + move.to + (move.promotion ? move.promotion : '');
  
  if (m.top_moves.includes(uci)) {
    updateBoard();
    showToast('Correct! Great move! ğŸ‘', 'success');
    setTimeout(() => {
      if (index < filtered.length - 1) next();
    }, 1500);
  } else {
    game.undo();
    board.set({ fen: game.fen() });
    showToast('Not the best move. Try again!', 'warning');
  }
}

function updateBoard() {
  if (!game || !board) return;
  const fen = game.fen();
  board.set({
    fen: fen
  });
}

// ============================================================================
// Position Navigation
// ============================================================================
function prev() {
  if (index > 0) {
    index--;
    show();
  }
}

function next() {
  if (index < filtered.length - 1) {
    index++;
    show();
  }
}

function jumpTo(i) {
  if (!filtered.length) return;
  index = Math.max(0, Math.min(filtered.length - 1, i));
  show();
}

function getSeverity(cpLoss) {
  if (cpLoss >= 300) return { class: 'severe', label: 'Severe', color: 'var(--danger)' };
  if (cpLoss >= 180) return { class: 'high', label: 'High', color: 'var(--warning)' };
  return { class: 'moderate', label: 'Moderate', color: 'var(--accent)' };
}

function show() {
  if (!filtered.length) {
    document.getElementById('info').innerHTML = '<div class="alert alert-secondary">No positions available.</div>';
    document.getElementById('topMoves').innerHTML = '';
    document.getElementById('posText').textContent = 'No positions';
    return;
  }
  
  const m = filtered[index];
  game = new Chess(m.fen);
  
  const orientation = game.turn() === 'w' ? 'white' : 'black';
  board.set({
    fen: m.fen,
    orientation: orientation,
    check: game.in_check()
  });
  
  const severity = getSeverity(m.avg_cp_loss);
  const turnText = game.turn() === 'w' ? 'White' : 'Black';
  const yourMove = uciToSan(m.user_move, m.fen);
  
  document.getElementById('info').innerHTML = `
    <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
      <div>
        <div class="text-muted small mb-1">Your Move</div>
        <div class="h5 mb-2">${yourMove}</div>
        <div class="text-muted small">${turnText} to move Â· Frequency: ${m.pair_count}</div>
      </div>
      <div class="text-end">
        <div class="text-muted small mb-1">CP Loss</div>
        <div class="h4 mb-1" style="color: ${severity.color};">${m.avg_cp_loss}</div>
        <span class="badge-soft" style="font-size: 0.75rem; background: ${severity.color}20; color: ${severity.color}; border-color: ${severity.color}40;">${severity.label}</span>
      </div>
    </div>
  `;
  
  const bestMoves = (m.top_moves || []).slice(0, 6);
  const bestList = bestMoves.length ? bestMoves.map((move, i) => {
    const san = uciToSan(move, m.fen);
    return `<button class="chip" onclick="previewMove('${move}')" title="Click to preview">${i === 0 ? 'ğŸ‘‘' : 'â€¢'} ${san}</button>`;
  }).join('') : '<span class="text-muted small">No engine suggestions</span>';
  document.getElementById('topMoves').innerHTML = bestList;
  
  document.getElementById('lichessLink').href = `https://lichess.org/analysis/${m.fen.replace(/ /g, '_')}`;
  document.getElementById('posText').textContent = `Position ${index + 1} of ${filtered.length}`;
  
  highlightRow();
}

function previewMove(uci) {
  if (!filtered.length || !game) return;
  const tempGame = new Chess(filtered[index].fen);
  const moveObj = { from: uci.slice(0, 2), to: uci.slice(2, 4) };
  if (uci.length > 4) moveObj.promotion = uci.slice(4);
  
  const result = tempGame.move(moveObj);
  if (result) {
    board.set({ fen: tempGame.fen() });
    setTimeout(() => board.set({ fen: filtered[index].fen }), 1000);
  }
}

function giveUp() {
  if (!filtered.length) return;
  const m = filtered[index];
  if (!m.top_moves || !m.top_moves.length) {
    showToast('No engine suggestion available.', 'info');
    return;
  }
  const best = m.top_moves[0];
  const san = uciToSan(best, m.fen);
  previewMove(best);
  showToast(`Best move: ${san} ğŸ’¡`, 'info');
}

function uciToSan(uci, fen) {
  try {
    const c = new Chess(fen);
    const moveObj = { from: uci.slice(0, 2), to: uci.slice(2, 4) };
    if (uci.length > 4) moveObj.promotion = uci.slice(4);
    const mv = c.move(moveObj);
    return (mv && mv.san) || uci;
  } catch (e) {
    return uci;
  }
}

// ============================================================================
// Filtering & Sorting
// ============================================================================
function applyFilters() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  const minCpRaw = parseInt(document.getElementById('minCpInput').value || '0', 10);
  const minCp = isNaN(minCpRaw) ? 0 : minCpRaw;
  const onlyTop = document.getElementById('onlyTopInput').checked;
  const severityFilter = document.getElementById('severityFilter').value;
  
  filtered = mistakes.filter((m) => {
    if (minCp && m.avg_cp_loss < minCp) return false;
    if (onlyTop && (!m.top_moves || !m.top_moves.length)) return false;
    
    if (severityFilter) {
      if (severityFilter === 'severe' && m.avg_cp_loss < 300) return false;
      if (severityFilter === 'high' && (m.avg_cp_loss < 180 || m.avg_cp_loss >= 300)) return false;
      if (severityFilter === 'moderate' && m.avg_cp_loss >= 180) return false;
    }
    
    if (!query) return true;
    const san = uciToSan(m.user_move, m.fen);
    const topSans = (m.top_moves || []).map(mv => uciToSan(mv, m.fen)).join(' ');
    const haystack = `${m.user_move} ${san} ${topSans}`.toLowerCase();
    return haystack.includes(query);
  });
  
  sortFiltered();
  const empty = document.getElementById('emptyFiltered');
  empty.classList.toggle('d-none', filtered.length > 0);
  if (index >= filtered.length) index = Math.max(0, filtered.length - 1);
  renderTable();
  show();
  
  document.getElementById('mistakeCount').textContent = filtered.length;
}

function sortFiltered() {
  const key = sortKey;
  const dir = sortDir === 'asc' ? 1 : -1;
  filtered.sort((a, b) => {
    if (key === 'index') {
      return dir * (mistakes.indexOf(a) - mistakes.indexOf(b));
    }
    const va = a[key] || 0;
    const vb = b[key] || 0;
    if (typeof va === 'string' || typeof vb === 'string') {
      return dir * String(va).localeCompare(String(vb));
    }
    return dir * (va - vb);
  });
  document.querySelectorAll('.sort-icon').forEach(el => {
    const k = el.dataset.key;
    el.textContent = k === key ? (dir === 1 ? 'â†‘' : 'â†“') : 'â‡…';
  });
}

function setSort(key) {
  if (sortKey === key) {
    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  } else {
    sortKey = key;
    sortDir = 'desc';
  }
  sortFiltered();
  renderTable();
}

function resetFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('minCpInput').value = '{{ threshold_cp }}';
  document.getElementById('onlyTopInput').checked = false;
  document.getElementById('severityFilter').value = '';
  applyFilters();
}

// ============================================================================
// Table Rendering
// ============================================================================
function renderTable() {
  const tbody = document.getElementById('mistakeTable');
  tbody.innerHTML = '';
  
  filtered.forEach((m, i) => {
    const row = document.createElement('tr');
    row.id = `row-${i}`;
    row.style.cursor = 'pointer';
    row.onclick = (e) => {
      if (!e.target.closest('button')) {
        index = i;
        show();
      }
    };
    
    const severity = getSeverity(m.avg_cp_loss);
    const deleteButton = color ? `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteMistake(${i})" title="Remove">ğŸ—‘ï¸</button>` : '';
    const colorBadge = m.color ? (m.color === 'white' ? 'â¬œ' : 'â¬›') : '';
    const san = uciToSan(m.user_move, m.fen);
    
    row.innerHTML = `
      <td class="text-muted small">${i + 1}</td>
      <td><strong>${m.pair_count}</strong></td>
      <td><span style="color: ${severity.color}; font-weight: 600;">${m.avg_cp_loss}</span></td>
      <td class="small">${colorBadge} ${san}</td>
      <td><span class="badge-soft" style="font-size: 0.7rem; background: ${severity.color}20; color: ${severity.color};">${severity.label}</span></td>
      <td>
        <div class="d-flex gap-1 justify-content-end">
          <button class="btn btn-primary btn-xs" onclick="event.stopPropagation(); index=${i}; show();" title="View">ğŸ‘ï¸</button>
          ${deleteButton}
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  highlightRow();
}

function highlightRow() {
  document.querySelectorAll('#mistakeTable tr').forEach(tr => tr.classList.remove('table-primary'));
  const row = document.getElementById(`row-${index}`);
  if (row) {
    row.classList.add('table-primary');
    row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ============================================================================
// Actions
// ============================================================================
function deleteMistake(i) {
  if (!color) return;
  if (!confirm('Remove this mistake from your training queue?')) return;
  
  const target = filtered[i];
  const absoluteIndex = mistakes.indexOf(target);
  
  fetch(`/delete_mistake/${color}/${absoluteIndex}`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        mistakes.splice(absoluteIndex, 1);
        deletedCount++;
        updateMasteryRate();
        applyFilters();
        showToast('Mistake removed! ğŸ‰', 'success');
      }
    })
    .catch(() => showToast('Failed to delete.', 'danger'));
}

function copyFen() {
  if (!filtered.length) return;
  const fen = filtered[index].fen;
  navigator.clipboard.writeText(fen).then(() => {
    showToast('FEN copied! ğŸ“‹', 'success');
  }).catch(() => {
    prompt('Copy FEN:', fen);
  });
}

function exportAnalysis() {
  const data = {
    exported_at: new Date().toISOString(),
    color: color,
    mistakes: filtered
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `chess-analysis-${color || 'all'}-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Analysis exported! ğŸ“¥', 'success');
}

function printAnalysis() {
  window.print();
}

function updateMasteryRate() {
  const rate = mistakes.length > 0 ? Math.round((deletedCount / (deletedCount + filtered.length)) * 100) : 0;
  document.getElementById('masteryRate').textContent = rate + '%';
}

// ============================================================================
// Keyboard Shortcuts
// ============================================================================
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
  if (e.key === 'ArrowRight') { e.preventDefault(); next(); }
  if (e.key === 'Home') { e.preventDefault(); jumpTo(0); }
  if (e.key === 'End') { e.preventDefault(); jumpTo(filtered.length - 1); }
  if (e.key === 'h' || e.key === 'H') { e.preventDefault(); giveUp(); }
  if (e.key === 'f' || e.key === 'F') { e.preventDefault(); flipBoard(); }
});

// ============================================================================
// Initialization
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
  // Wait for Chessground to load
  let attempts = 0;
  const waitForChessground = setInterval(function() {
    if (typeof window.Chessground !== 'undefined') {
      clearInterval(waitForChessground);
      initChessboard();
    } else if (attempts++ > 30) {
      clearInterval(waitForChessground);
      console.error('Chessground failed to load');
      document.getElementById('board').innerHTML = '<div class="alert alert-danger">Board failed to load. Please refresh the page.</div>';
    }
  }, 100);
  
  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('minCpInput').addEventListener('input', applyFilters);
  document.getElementById('severityFilter').addEventListener('change', applyFilters);
  document.getElementById('onlyTopInput').addEventListener('change', applyFilters);
  
  applyFilters();
  updateMasteryRate();
});
</script>

<style>
#boardContainer {
  display: block;
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
  background: #f0f0f0;
  border-radius: 8px;
}

#board {
  width: 100%;
  height: 500px;
  max-width: 500px;
  margin: 0 auto;
  aspect-ratio: 1;
  display: block;
  background: #f0d9b5;
}

.cg-wrap {
  width: 100%;
  height: 100%;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.btn-xs {
  padding: 0.25rem 0.4rem;
  font-size: 0.75rem;
}

.cursor-pointer {
  cursor: pointer;
  user-select: none;
}

.cursor-pointer:hover {
  color: var(--accent);
}

#settingsPanel,
#statsPanel {
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.table-sm td {
  padding: 0.4rem;
}

.table-sm th {
  padding: 0.6rem 0.4rem;
}
</style>
{% endif %}
{% endblock %}
